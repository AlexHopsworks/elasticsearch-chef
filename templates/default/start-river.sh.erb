#!/bin/sh

# SQL here is found in: Elastic_Rivers_Parent_Optimized.sql.erb

if [ "$#" -ne 1 ]  ; then
  echo "usage: <prog> river-name.json"
  exit 1
fi

river=$1


if [ "${JDBC_IMPORTER_HOME}" = "" ] ; then
 export JDBC_IMPORTER_HOME=<%= @install_path %>
fi


bin=$JDBC_IMPORTER_HOME/bin
lib=$JDBC_IMPORTER_HOME/lib
rivers=$JDBC_IMPORTER_HOME/rivers
river_dir="$(dirname $river)" 
river_pid=${river#$river_dir}.pid
if [ -f $rivers/$river_pid ]  ; then
  PID=`cat $rivers/$river_pid`
  # Test if process is already running, if yes, dont restart it
  if [ $(kill -0 $PID 2> /dev/null ; echo $?) -eq 0 ] ; then
    echo "$river is already running. Cannot start it."
    exit 2
  fi
fi

river_log=$JDBC_IMPORTER_HOME/logs/${river#$river_dir}.log
nohup java -cp "${lib}/*" -Dlog4j.configurationFile=${bin}/log4j2.xml org.xbib.tools.Runner org.xbib.tools.JDBCImporter $river > $river_log 2>&1 &
echo $! > $rivers/$river_pid
