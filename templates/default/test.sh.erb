#!/bin/bash

if [ "${JDBC_IMPORTER_HOME}" = ""  ; then
 export JDBC_IMPORTER_HOME=<%= @install_path %>
fi

#!/bin/bash

export JDBC_IMPORTER_HOME=/usr/local/elasticsearch-jdbc-1.7.1.0
curl -XDELETE 'localhost:9200/myjdbc'
bin=$JDBC_IMPORTER_HOME/bin
lib=$JDBC_IMPORTER_HOME/lib
echo '
{
    "type" : "jdbc",
    "jdbc" : {
        "url" : "jdbc:mysql://<%= @mysql_endpoint %>/test",
        "user" : "<%= @mysql_user %>",
        "password" : "<%= @mysql_password %>",
        "locale" : "en_US",
        "sql" : [
            {
                "statement" : "select \"myjdbc\" as _index, \"mytype\" as _type, name as _id, city, zip, address, lat as \"location.lat\", lon as \"location.lon\" from geo"
            }
        ,
        "index" : "myjdbc",
        "type" : "mytype",
        "index_settings" : {
            "index" : {
                "number_of_shards" : 1
            }
        },
        "type_mapping": {
            "mytype" : {
                "properties" : {
                    "location" : {
                        "type" : "geo_point"
                    }
                }
            }
        }
    }
}'  | java \
              -cp "${lib}/*" \
              -Dlog4j.configurationFile=${bin}/log4j2.xml \
              org.xbib.tools.Runner \
              org.xbib.tools.JDBCImporter
echo "sleeping while importer should run..."
sleep 10
curl -XGET "<%= @elastic_ip %>:9200/myjdbc/_refresh"
curl -XPOST "<%= @elastic_ip %>::9200/myjdbc/_search?pretty" -d '
{
  "query": {
     "filtered": {
       "query": {
          "match_all": {
           }
       },
       "filter": {
           "geo_distance" : {
               "distance" : "20km",
               "location" : {
                    "lat" : 51.0,
                    "lon" : 7.0
                }
            }
        }
     }
   }
}'
